<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Controle Financeiro ‚Äî Local</title>
  <meta name="color-scheme" content="light dark">
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#4dabf7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Controle Financeiro">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Controle Financeiro">
  <meta name="msapplication-TileColor" content="#4dabf7">
  <meta name="description" content="Controle suas finan√ßas de forma simples e offline">
  
  <!-- Manifest -->
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ29udHJvbGUgRmluYW5jZWlybyIsInNob3J0X25hbWUiOiJGaW5hbsOnYXMiLCJkZXNjcmlwdGlvbiI6IkNvbnRyb2xlIHN1YXMgZmluYW7Dp2FzIGRlIGZvcm1hIHNpbXBsZXMgZSBvZmZsaW5lIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwYjBmMTQiLCJ0aGVtZV9jb2xvciI6IiM0ZGFiZjciLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRJNElpQm9aV2xuYUhROUlqRXlPQ0lnZG1sbGQwSnZlRDBpTUNBd0lERXlPQ0F4TWpnaUlIaHRiRzV6UFNKB2RIUndPaTh2ZDNkM0xuY3pMbTl5Wnk4eU1EQXdMMk4yWnlJK1BHTnBjbU5zWlNCamVEMGlOalFpSUdONVBTSTJOQ0lnY2owaU5EZ2lJR1pwYkd3OUlpTTBaR0ZpWmpjaVBqeHZjR0YwYVhSNUlHWnBiR3c5SWlNd05qRXlNV1lpUGp3dmIzQmhkR2wwZVQ0OEwyTnBjbU5zWlQ0OEwzTjJaejQ9IiwidHlwZSI6ImltYWdlL3N2Zyt4bWwiLCJzaXplcyI6IjEyOHgxMjgifV19">
  
  <style>
    :root{
      --bg: #0b0f14;
      --panel: #121821;
      --muted: #6b7785;
      --text: #e8eef6;
      --green: #2ecc71;
      --red: #ff6b6b;
      --accent: #4dabf7;
      --accent-2: #82cfff;
      --border: #1d2633;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius: 16px;
      --radius-sm: 12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;overflow-x:hidden;}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background: 
        radial-gradient(1200px 800px at 10% -10%, #152135 0%, transparent 50%),
        radial-gradient(1000px 800px at 110% 10%, #132034 0%, transparent 45%),
        var(--bg);
      color:var(--text);
      line-height:1.45;
      position: relative;
      width: 100%;
      min-width: 320px;
    }

    /* Media query para detectar dispositivos m√≥veis */
    @media (hover: none) and (pointer: coarse) {
      body {
        /* Fundo est√°tico para mobile */
        background: var(--bg);
        background-image: 
          radial-gradient(circle at 20% 50%, rgba(77,171,247,.08) 0%, transparent 50%),
          radial-gradient(circle at 80% 20%, rgba(130,207,255,.06) 0%, transparent 50%);
      }
      
      /* Remover anima√ß√µes em mobile */
      *, *::before, *::after {
        animation-duration: 0s !important;
        animation-delay: 0s !important;
        transition-duration: 0.1s !important;
      }
      
      /* Otimiza√ß√µes para mobile */
      .container {
        padding: 12px;
        gap: 12px;
        width: 100%;
        margin: 0;
        box-sizing: border-box;
      }
      
      .card {
        border-radius: 12px;
        width: 100%;
        box-sizing: border-box;
      }
      
      .new-transaction-btn {
        padding: 10px 20px;
        font-size: 14px;
      }
      
      .stats {
        gap: 8px;
        grid-template-columns: 1fr; /* Uma coluna em telas muito pequenas */
      }
      
      .pill {
        padding: 8px 10px;
        text-align: center; /* Centraliza em mobile */
      }
      
      .pill .value {
        font-size: 16px; /* Menor em mobile */
        word-break: break-all;
        overflow-wrap: break-word;
      }
      
      /* Melhorar toque em mobile */
      .chip, .btn {
        min-height: 44px;
        min-width: 44px;
      }
      
      /* Otimizar modal para mobile */
      dialog {
        width: 95vw;
        max-width: none;
        border-radius: 16px;
        max-height: 85vh;
      }
      
      .modal-head {
        padding: 16px;
        font-size: 18px;
      }
      
      .modal-body {
        padding: 16px;
        gap: 16px;
      }
      
      .modal-actions {
        padding: 16px;
        gap: 12px;
      }
      
      .modal-body input,
      .modal-body select {
        padding: 12px;
        font-size: 16px; /* Evita zoom no iOS */
        border-radius: 8px;
      }
      
      .modal-body label {
        font-size: 14px;
        margin-bottom: 8px;
      }
      
      /* Tabela responsiva */
      table {
        font-size: 12px;
        overflow-x: auto;
        display: block;
        white-space: nowrap;
        width: 100%;
      }
      
      thead, tbody {
        display: table;
        width: 100%;
      }
      
      th, td {
        padding: 6px 4px;
        font-size: 12px;
        max-width: 80px;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .amount {
        font-size: 12px !important;
        word-break: break-all;
      }
    }
    
    /* iOS espec√≠fico - corrigir problema de centraliza√ß√£o */
    @supports (-webkit-touch-callout: none) {
      body {
        width: 100vw;
        max-width: 100%;
        margin: 0;
        padding: 0;
      }
      
      .container {
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        padding: 12px;
        box-sizing: border-box;
      }
      
      header.appbar {
        width: 100%;
        margin: 0;
        padding: 0;
      }
      
      header .row {
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        padding: 10px 16px;
        box-sizing: border-box;
      }
    }
    
    /* Para telas muito pequenas */
    @media (max-width: 480px) {
      .stats {
        grid-template-columns: 1fr;
        gap: 6px;
      }
      
      .pill .value {
        font-size: 14px;
      }
      
      .brand {
        font-size: 14px;
      }
      
      .month-nav {
        flex-wrap: wrap;
        gap: 4px;
      }
      
      .chip {
        padding: 6px 8px;
        font-size: 12px;
      }
      
      header .row {
        flex-direction: column;
        gap: 8px;
        padding: 8px 12px;
      }
      
      table {
        font-size: 10px;
      }
      
      th, td {
        padding: 4px 2px;
        font-size: 10px;
      }
      
      /* Modal ainda mais otimizado para telas pequenas */
      dialog {
        width: 100vw;
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
        margin: 0;
      }
      
      .modal-head {
        padding: 12px 16px;
        font-size: 16px;
      }
      
      .modal-body {
        padding: 12px 16px;
        gap: 12px;
      }
      
      .modal-actions {
        padding: 12px 16px;
        gap: 8px;
      }
      
      .modal-body input,
      .modal-body select {
        padding: 16px 12px;
        font-size: 16px;
      }
      
      .btn {
        padding: 16px 20px;
        font-size: 16px;
      }
    }

    /* Anima√ß√µes apenas para desktop */
    @media (hover: hover) and (pointer: fine) {
      body {
        background: 
          radial-gradient(circle at 20% 50%, rgba(77,171,247,.15) 0%, transparent 50%),
          radial-gradient(circle at 80% 20%, rgba(130,207,255,.12) 0%, transparent 50%),
          radial-gradient(circle at 40% 70%, rgba(46,204,113,.08) 0%, transparent 50%),
          radial-gradient(1200px 800px at 10% -10%, #152135 0%, transparent 50%),
          radial-gradient(1000px 800px at 110% 10%, #132034 0%, transparent 45%),
          var(--bg);
        background-size: 400px 400px, 600px 600px, 500px 500px, 1200px 800px, 1000px 800px;
        animation: backgroundMove 20s ease-in-out infinite;
      }

      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 
          linear-gradient(45deg, transparent 48%, rgba(77,171,247,.02) 50%, transparent 52%),
          linear-gradient(-45deg, transparent 48%, rgba(130,207,255,.015) 50%, transparent 52%);
        background-size: 60px 60px, 80px 80px;
        animation: patternMove 30s linear infinite;
        pointer-events: none;
        z-index: -1;
      }
      
      @keyframes backgroundMove {
        0%, 100% {
          background-position: 0% 0%, 100% 0%, 0% 100%, 10% -10%, 110% 10%;
        }
        25% {
          background-position: 100% 0%, 0% 100%, 100% 0%, 20% 0%, 90% 20%;
        }
        50% {
          background-position: 100% 100%, 0% 0%, 100% 100%, 0% 10%, 100% 0%;
        }
        75% {
          background-position: 0% 100%, 100% 0%, 0% 0%, -10% 20%, 120% -10%;
        }
      }

      @keyframes patternMove {
        0% { background-position: 0 0, 0 0; }
        100% { background-position: 60px 60px, -80px 80px; }
      }
    }

    .container{
      max-width:1100px;
      margin-inline:auto;
      padding:16px;
      display:grid;
      gap:16px;
      position: relative;
      z-index: 1;
      width: 100%;
      box-sizing: border-box;
    }
    header.appbar{
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter:saturate(140%) blur(8px);
      background:linear-gradient(180deg, rgba(16,22,30,.85), rgba(16,22,30,.65));
      border-bottom:1px solid var(--border);
      width: 100%;
    }
    header .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:8px; padding:10px 16px;
      max-width:1100px; margin-inline:auto;
      width: 100%;
      box-sizing: border-box;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:700;
      letter-spacing:.2px;
    }
    .brand .dot{width:10px; height:10px; border-radius:999px; background:linear-gradient(135deg,var(--accent),var(--accent-2)); box-shadow:0 0 18px rgba(77,171,247,.7);}
    .month-nav{
      display:flex; align-items:center; gap:8px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius:999px; padding:6px;
    }
    .chip{
      border:none; background:transparent; color:var(--text);
      padding:8px 10px; border-radius:999px; cursor:pointer; font-weight:600;
      transition: all 0.2s ease;
    }
    .chip:hover{background:rgba(255,255,255,.06)}
    .chip.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#06121f}
    .chip.ghost{border:1px solid var(--border); background:rgba(255,255,255,.02)}
    .nowrap{white-space:nowrap}
    .grid{
      display:grid; gap:16px;
      grid-template-columns:1fr;
    }
    @media(min-width:900px){
      .grid{grid-template-columns: 360px 1fr;}
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      width: 100%;
      box-sizing: border-box;
    }
    .card .head{padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between}
    .card .content{padding:14px 16px}
    .stats{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
    .pill{
      background:rgba(255,255,255,.03); border:1px solid var(--border);
      padding:10px 12px; border-radius:var(--radius-sm);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      min-width: 0; /* Permite shrinking */
      overflow: hidden; /* Previne overflow */
    }
    .pill:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0,0,0,.3);
    }
    .pill h4{margin:0 0 6px 0; font-size:12px; color:var(--muted); font-weight:600}
    .pill .value{
      font-size:20px; 
      font-weight:800;
      word-break: break-all; /* Quebra n√∫meros longos */
      line-height: 1.2;
    }
    .value.positive{color:var(--green)} .value.negative{color:var(--red)}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    
    .new-transaction-section {
      display: flex;
      justify-content: center;
      margin: 16px 0;
      width: 100%;
    }
    
    .new-transaction-btn {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border: none;
      color: #06121f;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(77,171,247,.3);
    }
    
    .new-transaction-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(77,171,247,.4);
    }
    
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:rgba(255,255,255,.02); color:var(--text); outline:none;
      transition: border-color 0.2s ease;
      box-sizing: border-box;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
    }
    input[type="date"], input[type="number"]{appearance:none}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px; font-weight:600}
    .row{display:flex; gap:10px}
    .row > *{flex:1}
    .btn{
      appearance:none; border:none; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer;
      background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#06121f;
      transition: all 0.2s ease;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(77,171,247,.3);
    }
    .btn.secondary{background:rgba(255,255,255,.03); color:var(--text); border:1px solid var(--border)}
    .btn.secondary:hover{background:rgba(255,255,255,.06)}
    .btn.danger{background:linear-gradient(135deg,#ff8787,#ff6b6b); color:#2b0b0b}
    .btn.danger:hover{box-shadow: 0 4px 15px rgba(255,107,107,.3);}
    .btn.block{width:100%}
    table{width:100%; border-collapse:collapse; table-layout: fixed;}
    th, td{
      padding:10px 8px; 
      border-bottom:1px solid var(--border); 
      text-align:left; 
      vertical-align:top; 
      font-size:14px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    th{color:var(--muted); font-weight:700}
    tr:hover td{background:rgba(255,255,255,.02)}
    .tag{font-size:12px; border:1px solid var(--border); padding:4px 8px; border-radius:999px; color:var(--muted)}
    .amount.income{color:var(--green); font-weight:800; word-break: break-all;}
    .amount.expense{color:var(--red); font-weight:800; word-break: break-all;}
    .empty{padding:20px; color:var(--muted); text-align:center}
    .footer{padding:16px; text-align:center; color:var(--muted); font-size:12px}
    dialog{
      border:none; padding:0; border-radius:18px; width:min(560px, 95vw);
      background:linear-gradient(180deg, rgba(16,22,30,.98), rgba(16,22,30,.96));
      color:var(--text);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      max-height: 90vh;
      overflow-y: auto;
    }
    dialog::backdrop{background:rgba(0,0,0,.5); backdrop-filter: blur(2px)}
    .modal-head{display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid var(--border)}
    .modal-body{padding:14px 16px; display:grid; gap:12px}
    .modal-actions{display:flex; justify-content:flex-end; gap:8px; padding:14px 16px; border-top:1px solid var(--border)}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0}
    .controls{display:flex; gap:8px; flex-wrap:wrap}
    .search{flex:1; min-width:160px}
    .small{font-size:12px; color:var(--muted)}
    .series{font-size:12px; color:var(--muted)}
    .link{background:none; border:none; padding:0; color:var(--accent-2); cursor:pointer}
    
    /* Bot√£o de exclus√£o simplificado */
    .delete-btn {
      background: rgba(255,107,107,.1);
      border: 1px solid rgba(255,107,107,.3);
      color: var(--red);
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }
    
    .delete-btn:hover {
      background: rgba(255,107,107,.2);
      border-color: rgba(255,107,107,.5);
    }
  </style>
</head>
<body>
  <header class="appbar">
    <div class="row">
      <div class="brand"><span class="dot"></span><span>Controle Financeiro</span></div>
      <div class="month-nav">
        <button class="chip ghost nowrap" id="prevMonthBtn" title="M√™s anterior">‚óÄ</button>
        <div class="chip primary nowrap" id="monthLabel">M√™s Atual</div>
        <button class="chip ghost nowrap" id="nextMonthBtn" title="Pr√≥ximo m√™s">‚ñ∂</button>
        <button class="chip ghost nowrap" id="todayBtn" title="Voltar para o m√™s atual">Hoje</button>
      </div>
      <div></div>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="head">
        <div>Vis√£o do m√™s</div>
        <div class="small" id="monthSummaryRange"></div>
      </div>
      <div class="content">
        <div class="stats">
          <div class="pill">
            <h4>Receitas</h4>
            <div class="value positive" id="incomeTotal">R$ 0,00</div>
          </div>
          <div class="pill">
            <h4>Despesas</h4>
            <div class="value negative" id="expenseTotal">R$ 0,00</div>
          </div>
          <div class="pill">
            <h4>Saldo</h4>
            <div class="value" id="balanceTotal">R$ 0,00</div>
          </div>
        </div>
      </div>
    </section>

    <div class="new-transaction-section">
      <button id="newTxnBtn" class="new-transaction-btn">+ Nova transa√ß√£o</button>
    </div>

    <section class="card">
      <div class="head">
        <div>Transa√ß√µes do M√™s</div>
      </div>
      <div class="content">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Descri√ß√£o</th>
              <th>Tipo</th>
              <th>Parcela</th>
              <th>Valor</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="txnTbody"></tbody>
        </table>
        <div id="emptyState" class="empty" style="display:none">Nenhuma transa√ß√£o neste m√™s.</div>
      </div>
    </section>
    <div class="footer">Dados salvos no seu navegador (localStorage). Ideal para GitHub Pages/localhost.</div>
  </main>

  <dialog id="txnDialog">
    <form method="dialog" id="txnForm">
      <div class="modal-head">
        <strong id="dialogTitle">Nova transa√ß√£o</strong>
        <button class="link" value="cancel">Fechar</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div>
            <label for="type">Tipo</label>
            <select id="type" required>
              <option value="income">Receita</option>
              <option value="expense">Despesa</option>
            </select>
          </div>
          <div>
            <label for="amount">Valor (R$)</label>
            <input id="amount" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0,00" required />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="date">Data de pagamento</label>
            <input id="date" type="date" required />
          </div>
          <div>
            <label for="installments">Parcelas (1 = √∫nico)</label>
            <input id="installments" type="number" min="1" max="120" value="1" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="description">Descri√ß√£o</label>
            <input id="description" placeholder="Ex.: Sal√°rio, Aluguel, Mercado, Compras..." />
          </div>
        </div>
        <div class="small">Dica: use <strong>Parcelas</strong> para repetir o mesmo valor por v√°rios meses (1 por m√™s). Cada parcela fica vinculada como uma s√©rie.</div>
      </div>
      <div class="modal-actions">
        <button class="btn secondary" value="cancel">Cancelar</button>
        <button class="btn" id="saveBtn" value="default">Salvar</button>
      </div>
    </form>
  </dialog>

  <template id="rowTpl">
    <tr>
      <td class="date"></td>
      <td class="desc"></td>
      <td class="type"></td>
      <td class="install"></td>
      <td class="amt"></td>
      <td class="actions"></td>
    </tr>
  </template>

  <script>
  ;(() => {
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const monthFmt = new Intl.DateTimeFormat('pt-BR', { month: 'long', year: 'numeric' });
    const dayFmt = new Intl.DateTimeFormat('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });

    const STORAGE_KEY = 'financeData.v1';
    const state = {
      txns: [], // {id, type: 'income'|'expense', amount, date: 'YYYY-MM-DD', category, description, seriesId?, seriesIndex?, seriesCount?}
      selectedYM: ymOf(new Date())
    };

    // Load
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed.txns)) state.txns = parsed.txns;
      }
    } catch(e){ console.warn('Erro ao carregar storage', e) }

    // Auto ir para m√™s atual ao abrir em um novo m√™s
    const todayYM = ymOf(new Date());
    if (state.selectedYM !== todayYM) state.selectedYM = todayYM;

    // Elements
    const monthLabel = $('#monthLabel');
    const monthSummaryRange = $('#monthSummaryRange');
    const tbody = $('#txnTbody');
    const emptyState = $('#emptyState');

    const dialog = $('#txnDialog');
    const form = $('#txnForm');
    const dialogTitle = $('#dialogTitle');
    const saveBtn = $('#saveBtn');

    const typeEl = $('#type');
    const amountEl = $('#amount');
    const dateEl = $('#date');
    const installmentsEl = $('#installments');
    const descEl = $('#description');

    // Events
    $('#prevMonthBtn').addEventListener('click', () => { 
      state.selectedYM = addMonthsYM(state.selectedYM, -1); 
      checkAutoCleanup();
      render(); 
    });
    $('#nextMonthBtn').addEventListener('click', () => { 
      state.selectedYM = addMonthsYM(state.selectedYM, 1); 
      checkAutoCleanup();
      render(); 
    });
    $('#todayBtn').addEventListener('click', () => { 
      state.selectedYM = ymOf(new Date()); 
      checkAutoCleanup();
      render(); 
    });
    $('#newTxnBtn').addEventListener('click', () => openNewDialog());

    // Fechar modal clicando fora
    dialog.addEventListener('click', (e) => {
      if (e.target === dialog) {
        dialog.close();
      }
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      handleSave();
    });

    // Helpers
    function persist(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ txns: state.txns }));
    }
    function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function pad(n){ return String(n).padStart(2,'0'); }
    function ymOf(d){ const dt = new Date(d); return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}`; }
    function addMonths(date, n){
      const d = new Date(date);
      const day = d.getDate();
      d.setMonth(d.getMonth()+n);
      // manter dia ao m√°ximo poss√≠vel
      if (d.getDate() !== day) d.setDate(0);
      return d;
    }
    function addMonthsYM(ym, n){
      const [y,m] = ym.split('-').map(Number);
      const d = new Date(y, m-1, 1);
      const r = addMonths(d, n);
      return ymOf(r);
    }
    function firstDayOfYM(ym){ const [y,m] = ym.split('-').map(Number); return new Date(y, m-1, 1); }
    function lastDayOfYM(ym){ const [y,m] = ym.split('-').map(Number); return new Date(y, m, 0); }

    // Limpeza autom√°tica de dados antigos (manter apenas √∫ltimos 12 meses)
    function checkAutoCleanup(){
      const currentDate = new Date();
      const cutoffDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 12, 1);
      
      const initialCount = state.txns.length;
      state.txns = state.txns.filter(txn => {
        const txnDate = new Date(txn.date);
        return txnDate >= cutoffDate;
      });
      
      if (state.txns.length !== initialCount) {
        persist();
        console.log(`Limpeza autom√°tica: ${initialCount - state.txns.length} transa√ß√µes antigas removidas`);
      }
    }

    function openNewDialog(){
      dialogTitle.textContent = 'Nova transa√ß√£o';
      form.dataset.mode = 'create';
      form.dataset.id = '';
      typeEl.value = 'expense';
      amountEl.value = '';
      const d = new Date();
      dateEl.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      installmentsEl.value = 1;
      descEl.value = '';
      dialog.showModal();
    }

    function handleSave(){
      const type = typeEl.value;
      const amount = Number(amountEl.value);
      const date = dateEl.value;
      const description = descEl.value.trim();
      const installments = Math.max(1, parseInt(installmentsEl.value || '1', 10));

      if (!date || isNaN(amount)) return;

      if (installments === 1){
        state.txns.push({
          id: uid(), type, amount, date, description
        });
      } else {
        const seriesId = uid();
        const d0 = new Date(date);
        for (let i=0;i<installments;i++){
          const di = addMonths(d0, i);
          const dt = `${di.getFullYear()}-${pad(di.getMonth()+1)}-${pad(Math.min(d0.getDate(), daysInMonth(di)))}`;
          state.txns.push({
            id: uid(), type, amount, date: dt, description,
            seriesId, seriesIndex: i+1, seriesCount: installments
          });
        }
      }
      persist();
      dialog.close();
      render();
    }

    function daysInMonth(d){
      return new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
    }

    function removeTxn(id){
      const t = state.txns.find(x=>x.id===id);
      if (!t) return;
      if (t.seriesId){
        const ans = confirm('Esta transa√ß√£o faz parte de uma s√©rie de parcelas. Deseja apagar somente esta parcela?\n\nOK = Apenas esta\nCancelar = Apagar toda a s√©rie');
        if (ans){
          state.txns = state.txns.filter(x => x.id !== id);
        } else {
          state.txns = state.txns.filter(x => x.seriesId !== t.seriesId);
        }
      } else {
        if (!confirm('Apagar esta transa√ß√£o?')) return;
        state.txns = state.txns.filter(x => x.id !== id);
      }
      persist(); render();
    }

    function render(){
      // Header
      const ym = state.selectedYM;
      const [y,m] = ym.split('-').map(Number);
      const first = firstDayOfYM(ym);
      const last = lastDayOfYM(ym);
      monthLabel.textContent = monthFmt.format(first).replace(/^./, c => c.toUpperCase());
      monthSummaryRange.textContent = `${dayFmt.format(first)} ‚Äì ${dayFmt.format(last)}`;

      // Stats
      const txnsMonth = filteredTxns();
      const income = txnsMonth.filter(t => t.type === 'income').reduce((s,t)=>s+t.amount,0);
      const expense = txnsMonth.filter(t => t.type === 'expense').reduce((s,t)=>s+t.amount,0);
      $('#incomeTotal').textContent = fmt.format(income);
      $('#expenseTotal').textContent = fmt.format(expense);
      const balance = income - expense;
      const balEl = $('#balanceTotal');
      balEl.textContent = fmt.format(balance);
      balEl.classList.toggle('positive', balance >= 0);
      balEl.classList.toggle('negative', balance < 0);

      renderTable();
    }

    function filteredTxns(){
      const ym = state.selectedYM;
      const [y,m] = ym.split('-').map(Number);
      return state.txns
        .filter(t => {
          const d = new Date(t.date);
          const inMonth = d.getFullYear() === y && (d.getMonth()+1) === m;
          return inMonth;
        })
        .sort((a,b) => (a.date < b.date ? -1 : a.date > b.date ? 1 : 0));
    }

    function renderTable(){
      const rows = filteredTxns();
      tbody.innerHTML = '';
      if (rows.length === 0){
        emptyState.style.display = '';
        return;
      }
      emptyState.style.display = 'none';

      const tpl = $('#rowTpl');
      for (const t of rows){
        const tr = tpl.content.firstElementChild.cloneNode(true);
        tr.querySelector('.date').textContent = dayFmt.format(new Date(t.date));
        tr.querySelector('.desc').textContent = t.description || '‚Äî';
        tr.querySelector('.type').textContent = t.type === 'income' ? 'Receita' : 'Despesa';
        tr.querySelector('.install').textContent = t.seriesId ? `${t.seriesIndex}/${t.seriesCount}` : '‚Äî';
        const amt = tr.querySelector('.amt');
        amt.textContent = fmt.format(t.amount);
        amt.classList.add('amount', t.type === 'income' ? 'income' : 'expense');

        // Criar bot√£o de exclus√£o simplificado
        const actionsContainer = tr.querySelector('.actions');
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = 'üóëÔ∏è Excluir';
        deleteBtn.addEventListener('click', () => {
          removeTxn(t.id);
        });
        
        actionsContainer.appendChild(deleteBtn);
        tbody.appendChild(tr);
      }
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // Kickoff
    checkAutoCleanup(); // Executar limpeza autom√°tica na inicializa√ß√£o
    
    // PWA - Prompt de instala√ß√£o
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // Mostrar prompt ap√≥s 3 segundos
      setTimeout(() => {
        if (deferredPrompt && !window.matchMedia('(display-mode: standalone)').matches) {
          showInstallPrompt();
        }
      }, 3000);
    });

    function showInstallPrompt() {
      const installBanner = document.createElement('div');
      installBanner.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #06121f;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        font-size: 14px;
        font-weight: 600;
      `;
      
      installBanner.innerHTML = `
        <div>üì± Instale o app para acesso r√°pido!</div>
        <div>
          <button id="installBtn" style="
            background: rgba(255,255,255,0.2);
            border: none;
            color: #06121f;
            padding: 6px 12px;
            border-radius: 6px;
            margin-right: 8px;
            font-weight: 600;
            cursor: pointer;
          ">Instalar</button>
          <button id="dismissBtn" style="
            background: none;
            border: none;
            color: #06121f;
            padding: 6px;
            cursor: pointer;
            font-size: 16px;
          ">‚úï</button>
        </div>
      `;
      
      document.body.appendChild(installBanner);
      
      // Ajustar padding do corpo para compensar banner
      document.body.style.paddingTop = '60px';
      
      installBanner.querySelector('#installBtn').addEventListener('click', async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          deferredPrompt = null;
          removeBanner();
        }
      });
      
      installBanner.querySelector('#dismissBtn').addEventListener('click', removeBanner);
      
      function removeBanner() {
        installBanner.remove();
        document.body.style.paddingTop = '0';
      }
      
      // Auto remover ap√≥s 10 segundos
      setTimeout(removeBanner, 10000);
    }

    // Registrar Service Worker para PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('data:application/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZnVuY3Rpb24oZXZlbnQpIHsKICBzZWxmLnNraXBXYWl0aW5nKCk7Cn0pOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdhY3RpdmF0ZScsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgZXZlbnQud2FpdFVudGlsKHNlbGYuY2xpZW50cy5jbGFpbSgpKTsKfSk7CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2ZldGNoJywgZnVuY3Rpb24oZXZlbnQpIHsKICBldmVudC5yZXNwb25kV2l0aChmZXRjaChldmVudC5yZXF1ZXN0KSk7Cn0pOw==');
    }
    
    render();
  })();
  </script>
</body>
</html>
