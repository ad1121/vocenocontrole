<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle Financeiro — Local</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg: #0b0f14;
      --panel: #121821;
      --muted: #6b7785;
      --text: #e8eef6;
      --green: #2ecc71;
      --red: #ff6b6b;
      --accent: #4dabf7;
      --accent-2: #82cfff;
      --border: #1d2633;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius: 16px;
      --radius-sm: 12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 10% -10%, #152135 0%, transparent 50%),
                  radial-gradient(1000px 800px at 110% 10%, #132034 0%, transparent 45%),
                  var(--bg);
      color:var(--text);
      line-height:1.45;
    }
    .container{
      max-width:1100px;
      margin-inline:auto;
      padding:16px;
      display:grid;
      gap:16px;
    }
    header.appbar{
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter:saturate(140%) blur(8px);
      background:linear-gradient(180deg, rgba(16,22,30,.85), rgba(16,22,30,.65));
      border-bottom:1px solid var(--border);
    }
    header .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:8px; padding:10px 16px;
      max-width:1100px; margin-inline:auto;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:700;
      letter-spacing:.2px;
    }
    .brand .dot{width:10px; height:10px; border-radius:999px; background:linear-gradient(135deg,var(--accent),var(--accent-2)); box-shadow:0 0 18px rgba(77,171,247,.7);}
    .month-nav{
      display:flex; align-items:center; gap:8px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius:999px; padding:6px;
    }
    .chip{
      border:none; background:transparent; color:var(--text);
      padding:8px 10px; border-radius:999px; cursor:pointer; font-weight:600;
    }
    .chip:hover{background:rgba(255,255,255,.06)}
    .chip.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#06121f}
    .chip.ghost{border:1px solid var(--border); background:rgba(255,255,255,.02)}
    .nowrap{white-space:nowrap}
    .grid{
      display:grid; gap:16px;
      grid-template-columns:1fr;
    }
    @media(min-width:900px){
      .grid{grid-template-columns: 360px 1fr;}
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .card .head{padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between}
    .card .content{padding:14px 16px}
    .stats{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
    .pill{
      background:rgba(255,255,255,.03); border:1px solid var(--border);
      padding:10px 12px; border-radius:var(--radius-sm);
    }
    .pill h4{margin:0 0 6px 0; font-size:12px; color:var(--muted); font-weight:600}
    .pill .value{font-size:20px; font-weight:800}
    .value.positive{color:var(--green)} .value.negative{color:var(--red)}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:rgba(255,255,255,.02); color:var(--text); outline:none;
    }
    input[type="date"], input[type="number"]{appearance:none}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px; font-weight:600}
    .row{display:flex; gap:10px}
    .row > *{flex:1}
    .btn{
      appearance:none; border:none; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer;
      background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#06121f;
    }
    .btn.secondary{background:rgba(255,255,255,.03); color:var(--text); border:1px solid var(--border)}
    .btn.danger{background:linear-gradient(135deg,#ff8787,#ff6b6b); color:#2b0b0b}
    .btn.block{width:100%}
    table{width:100%; border-collapse:collapse}
    th, td{padding:10px 8px; border-bottom:1px solid var(--border); text-align:left; vertical-align:top; font-size:14px}
    th{color:var(--muted); font-weight:700}
    tr:hover td{background:rgba(255,255,255,.02)}
    .tag{font-size:12px; border:1px solid var(--border); padding:4px 8px; border-radius:999px; color:var(--muted)}
    .amount.income{color:var(--green); font-weight:800}
    .amount.expense{color:var(--red); font-weight:800}
    .empty{padding:20px; color:var(--muted); text-align:center}
    .footer{padding:16px; text-align:center; color:var(--muted); font-size:12px}
    dialog{
      border:none; padding:0; border-radius:18px; width:min(560px, 95vw);
      background:linear-gradient(180deg, rgba(16,22,30,.98), rgba(16,22,30,.96));
      color:var(--text);
      box-shadow:var(--shadow);
    }
    dialog::backdrop{background:rgba(0,0,0,.5); backdrop-filter: blur(2px)}
    .modal-head{display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid var(--border)}
    .modal-body{padding:14px 16px; display:grid; gap:12px}
    .modal-actions{display:flex; justify-content:flex-end; gap:8px; padding:14px 16px; border-top:1px solid var(--border)}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0}
    .controls{display:flex; gap:8px; flex-wrap:wrap}
    .search{flex:1; min-width:160px}
    .small{font-size:12px; color:var(--muted)}
    .series{font-size:12px; color:var(--muted)}
    .link{background:none; border:none; padding:0; color:var(--accent-2); cursor:pointer}
  </style>
</head>
<body>
  <header class="appbar">
    <div class="row">
      <div class="brand"><span class="dot"></span><span>Controle Financeiro</span></div>
      <div class="month-nav">
        <button class="chip ghost nowrap" id="prevMonthBtn" title="Mês anterior">◀</button>
        <div class="chip primary nowrap" id="monthLabel">Mês Atual</div>
        <button class="chip ghost nowrap" id="nextMonthBtn" title="Próximo mês">▶</button>
        <button class="chip ghost nowrap" id="todayBtn" title="Voltar para o mês atual">Hoje</button>
      </div>
      <div class="toolbar">
        <button id="newTxnBtn" class="chip primary nowrap">+ Nova transação</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="head">
        <div>Visão do mês</div>
        <div class="small" id="monthSummaryRange"></div>
      </div>
      <div class="content">
        <div class="stats">
          <div class="pill">
            <h4>Entradas</h4>
            <div class="value positive" id="incomeTotal">R$ 0,00</div>
          </div>
          <div class="pill">
            <h4>Saídas</h4>
            <div class="value negative" id="expenseTotal">R$ 0,00</div>
          </div>
          <div class="pill">
            <h4>Saldo</h4>
            <div class="value" id="balanceTotal">R$ 0,00</div>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="head">
        <div>Transações</div>
        <div class="controls">
          <input id="searchInput" class="search" placeholder="Buscar por descrição ou categoria…" />
          <select id="typeFilter">
            <option value="">Todas</option>
            <option value="income">Entradas</option>
            <option value="expense">Saídas</option>
          </select>
          <button id="exportBtn" class="btn secondary">Exportar</button>
          <label for="importFile" class="btn secondary" style="cursor:pointer">Importar</label>
          <input id="importFile" type="file" accept="application/json" class="sr-only" />
          <button id="clearBtn" class="btn danger">Zerar tudo</button>
        </div>
      </div>
      <div class="content">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Descrição</th>
              <th>Categoria</th>
              <th>Tipo</th>
              <th>Parcela</th>
              <th>Valor</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="txnTbody"></tbody>
        </table>
        <div id="emptyState" class="empty" style="display:none">Nenhuma transação neste mês.</div>
      </div>
    </section>
    <div class="footer">Dados salvos no seu navegador (localStorage). Ideal para GitHub Pages/localhost.</div>
  </main>

  <dialog id="txnDialog">
    <form method="dialog" id="txnForm">
      <div class="modal-head">
        <strong id="dialogTitle">Nova transação</strong>
        <button class="link" value="cancel">Fechar</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div>
            <label for="type">Tipo</label>
            <select id="type" required>
              <option value="income">Entrada</option>
              <option value="expense">Saída</option>
            </select>
          </div>
          <div>
            <label for="amount">Valor (R$)</label>
            <input id="amount" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0,00" required />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="date">Data de pagamento</label>
            <input id="date" type="date" required />
          </div>
          <div>
            <label for="installments">Parcelas (1 = único)</label>
            <input id="installments" type="number" min="1" max="120" value="1" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="category">Categoria</label>
            <input id="category" placeholder="Ex.: Salário, Aluguel, Mercado…" />
          </div>
          <div>
            <label for="description">Descrição</label>
            <input id="description" placeholder="Nota ou identificação" />
          </div>
        </div>
        <div class="small">Dica: use <strong>Parcelas</strong> para repetir o mesmo valor por vários meses (1 por mês). Cada parcela fica vinculada como uma série.</div>
      </div>
      <div class="modal-actions">
        <button class="btn secondary" value="cancel">Cancelar</button>
        <button class="btn" id="saveBtn" value="default">Salvar</button>
      </div>
    </form>
  </dialog>

  <template id="rowTpl">
    <tr>
      <td class="date"></td>
      <td class="desc"></td>
      <td class="cat"></td>
      <td class="type"></td>
      <td class="install"></td>
      <td class="amt"></td>
      <td class="actions"></td>
    </tr>
  </template>

  <script>
  ;(() => {
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const monthFmt = new Intl.DateTimeFormat('pt-BR', { month: 'long', year: 'numeric' });
    const dayFmt = new Intl.DateTimeFormat('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });

    const STORAGE_KEY = 'financeData.v1';
    const state = {
      txns: [], // {id, type: 'income'|'expense', amount, date: 'YYYY-MM-DD', category, description, seriesId?, seriesIndex?, seriesCount?}
      selectedYM: ymOf(new Date()),
      search: '',
      filterType: ''
    };

    // Load
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed.txns)) state.txns = parsed.txns;
      }
    } catch(e){ console.warn('Erro ao carregar storage', e) }

    // Auto ir para mês atual ao abrir em um novo mês
    const todayYM = ymOf(new Date());
    if (state.selectedYM !== todayYM) state.selectedYM = todayYM;

    // Elements
    const monthLabel = $('#monthLabel');
    const monthSummaryRange = $('#monthSummaryRange');
    const tbody = $('#txnTbody');
    const emptyState = $('#emptyState');

    const searchInput = $('#searchInput');
    const typeFilter = $('#typeFilter');

    const dialog = $('#txnDialog');
    const form = $('#txnForm');
    const dialogTitle = $('#dialogTitle');
    const saveBtn = $('#saveBtn');

    const typeEl = $('#type');
    const amountEl = $('#amount');
    const dateEl = $('#date');
    const installmentsEl = $('#installments');
    const catEl = $('#category');
    const descEl = $('#description');

    // Events
    $('#prevMonthBtn').addEventListener('click', () => { state.selectedYM = addMonthsYM(state.selectedYM, -1); render(); });
    $('#nextMonthBtn').addEventListener('click', () => { state.selectedYM = addMonthsYM(state.selectedYM, 1); render(); });
    $('#todayBtn').addEventListener('click', () => { state.selectedYM = ymOf(new Date()); render(); });
    $('#newTxnBtn').addEventListener('click', () => openNewDialog());

    searchInput.addEventListener('input', e => { state.search = e.target.value.toLowerCase(); renderTable(); });
    typeFilter.addEventListener('change', e => { state.filterType = e.target.value; renderTable(); });

    $('#exportBtn').addEventListener('click', exportData);
    $('#importFile').addEventListener('change', importData);
    $('#clearBtn').addEventListener('click', () => {
      if (confirm('Tem certeza que deseja apagar TODOS os dados? Esta ação não pode ser desfeita.')) {
        state.txns = []; persist(); render();
      }
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      handleSave();
    });

    // Helpers
    function persist(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ txns: state.txns }));
    }
    function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function pad(n){ return String(n).padStart(2,'0'); }
    function ymOf(d){ const dt = new Date(d); return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}`; }
    function addMonths(date, n){
      const d = new Date(date);
      const day = d.getDate();
      d.setMonth(d.getMonth()+n);
      // manter dia ao máximo possível
      if (d.getDate() !== day) d.setDate(0);
      return d;
    }
    function addMonthsYM(ym, n){
      const [y,m] = ym.split('-').map(Number);
      const d = new Date(y, m-1, 1);
      const r = addMonths(d, n);
      return ymOf(r);
    }
    function firstDayOfYM(ym){ const [y,m] = ym.split('-').map(Number); return new Date(y, m-1, 1); }
    function lastDayOfYM(ym){ const [y,m] = ym.split('-').map(Number); return new Date(y, m, 0); }

    function openNewDialog(){
      dialogTitle.textContent = 'Nova transação';
      form.dataset.mode = 'create';
      form.dataset.id = '';
      typeEl.value = 'expense';
      amountEl.value = '';
      const d = new Date();
      dateEl.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      installmentsEl.value = 1;
      catEl.value = '';
      descEl.value = '';
      dialog.showModal();
    }

    function openEditDialog(txn){
      dialogTitle.textContent = 'Editar transação';
      form.dataset.mode = 'edit';
      form.dataset.id = txn.id;
      typeEl.value = txn.type;
      amountEl.value = txn.amount;
      dateEl.value = txn.date;
      installmentsEl.value = txn.seriesCount || 1;
      catEl.value = txn.category || '';
      descEl.value = txn.description || '';
      dialog.showModal();
    }

    function handleSave(){
      const type = typeEl.value;
      const amount = Number(amountEl.value);
      const date = dateEl.value;
      const category = catEl.value.trim();
      const description = descEl.value.trim();
      const installments = Math.max(1, parseInt(installmentsEl.value || '1', 10));

      if (!date || isNaN(amount)) return;

      if (form.dataset.mode === 'edit'){
        const id = form.dataset.id;
        const idx = state.txns.findIndex(t => t.id === id);
        if (idx >= 0){
          const old = state.txns[idx];
          // Se fazia parte de série e mudou qtd parcelas, aplicamos somente nesta transação
          state.txns[idx] = { ...old, type, amount, date, category, description };
        }
      } else {
        if (installments === 1){
          state.txns.push({
            id: uid(), type, amount, date, category, description
          });
        } else {
          const seriesId = uid();
          const d0 = new Date(date);
          for (let i=0;i<installments;i++){
            const di = addMonths(d0, i);
            const dt = `${di.getFullYear()}-${pad(di.getMonth()+1)}-${pad(Math.min(d0.getDate(), daysInMonth(di)))}`;
            state.txns.push({
              id: uid(), type, amount, date: dt, category, description,
              seriesId, seriesIndex: i+1, seriesCount: installments
            });
          }
        }
      }
      persist();
      dialog.close();
      render();
    }

    function daysInMonth(d){
      return new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
    }

    function exportData(){
      const data = JSON.stringify({ txns: state.txns }, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'controle-financeiro.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importData(e){
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);
          if (parsed && Array.isArray(parsed.txns)){
            if (confirm('Substituir os dados atuais pelos dados importados?')){
              state.txns = parsed.txns;
              persist(); render();
            }
          } else alert('Arquivo inválido.');
        } catch(err){ alert('Falha ao importar: ' + err.message); }
      };
      reader.readAsText(file);
      // reset input to allow re-import
      e.target.value = '';
    }

    function removeTxn(id){
      const t = state.txns.find(x=>x.id===id);
      if (!t) return;
      if (t.seriesId){
        const ans = confirm('Esta transação faz parte de uma série de parcelas. Deseja apagar somente esta parcela?\n\nOK = Apenas esta\nCancelar = Apagar toda a série');
        if (ans){
          state.txns = state.txns.filter(x => x.id !== id);
        } else {
          state.txns = state.txns.filter(x => x.seriesId !== t.seriesId);
        }
      } else {
        if (!confirm('Apagar esta transação?')) return;
        state.txns = state.txns.filter(x => x.id !== id);
      }
      persist(); render();
    }

    function render(){
      // Header
      const ym = state.selectedYM;
      const [y,m] = ym.split('-').map(Number);
      const first = firstDayOfYM(ym);
      const last = lastDayOfYM(ym);
      monthLabel.textContent = monthFmt.format(first).replace(/^./, c => c.toUpperCase());
      monthSummaryRange.textContent = `${dayFmt.format(first)} – ${dayFmt.format(last)}`;

      // Stats
      const txnsMonth = filteredTxns();
      const income = txnsMonth.filter(t => t.type === 'income').reduce((s,t)=>s+t.amount,0);
      const expense = txnsMonth.filter(t => t.type === 'expense').reduce((s,t)=>s+t.amount,0);
      $('#incomeTotal').textContent = fmt.format(income);
      $('#expenseTotal').textContent = fmt.format(expense);
      const balance = income - expense;
      const balEl = $('#balanceTotal');
      balEl.textContent = fmt.format(balance);
      balEl.classList.toggle('positive', balance >= 0);
      balEl.classList.toggle('negative', balance < 0);

      renderTable();
    }

    function filteredTxns(){
      const ym = state.selectedYM;
      const [y,m] = ym.split('-').map(Number);
      const search = state.search;
      const typeFilter = state.filterType;
      return state.txns
        .filter(t => {
          const d = new Date(t.date);
          const inMonth = d.getFullYear() === y && (d.getMonth()+1) === m;
          if (!inMonth) return false;
          if (typeFilter && t.type !== typeFilter) return false;
          if (search){
            const hay = ((t.description||'') + ' ' + (t.category||'')).toLowerCase();
            if (!hay.includes(search)) return false;
          }
          return true;
        })
        .sort((a,b) => (a.date < b.date ? -1 : a.date > b.date ? 1 : 0));
    }

    function renderTable(){
      const rows = filteredTxns();
      tbody.innerHTML = '';
      if (rows.length === 0){
        emptyState.style.display = '';
        return;
      }
      emptyState.style.display = 'none';

      const tpl = $('#rowTpl');
      for (const t of rows){
        const tr = tpl.content.firstElementChild.cloneNode(true);
        tr.querySelector('.date').textContent = dayFmt.format(new Date(t.date));
        tr.querySelector('.desc').textContent = t.description || '—';
        tr.querySelector('.cat').innerHTML = t.category ? `<span class="tag">${escapeHtml(t.category)}</span>` : '—';
        tr.querySelector('.type').textContent = t.type === 'income' ? 'Entrada' : 'Saída';
        tr.querySelector('.install').textContent = t.seriesId ? `${t.seriesIndex}/${t.seriesCount}` : '—';
        const amt = tr.querySelector('.amt');
        amt.textContent = fmt.format(t.amount);
        amt.classList.add('amount', t.type === 'income' ? 'income' : 'expense');

        const actions = document.createElement('div');
        const editBtn = document.createElement('button');
        editBtn.className = 'chip ghost';
        editBtn.textContent = 'Editar';
        editBtn.addEventListener('click', () => openEditDialog(t));
        const delBtn = document.createElement('button');
        delBtn.className = 'chip ghost';
        delBtn.textContent = 'Excluir';
        delBtn.addEventListener('click', () => removeTxn(t.id));
        actions.append(editBtn, delBtn);
        tr.querySelector('.actions').append(actions);

        tbody.appendChild(tr);
      }
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // Kickoff
    render();
  })();
  </script>
</body>
</html>
