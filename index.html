<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Moderno</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --cor-primaria: #0d6efd;
            --cor-receita: #198754;
            --cor-despesa: #dc3545;
            --cor-fundo: #f7f8fb;
            --cor-card: #fff;
            --cor-borda: #e9ecef;
            --cor-cinza: #6c757d;
            --cor-shadow: rgba(0,0,0,0.06);
        }
        * {margin:0;padding:0;box-sizing:border-box;}
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: var(--cor-fundo);
            min-height:100vh;
            color: #222;
            transition: background 0.3s;
        }
        .topbar {
            background: var(--cor-card);
            border-bottom: 1px solid var(--cor-borda);
            padding: 18px 0 10px 0;
            box-shadow: 0 2px 8px var(--cor-shadow);
        }
        .topbar-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .logo {
            display: flex; align-items: center; gap: 10px;
            font-size: 2rem;
            font-weight: 700; color: var(--cor-primaria);
            letter-spacing: 2px;
        }
        .logo i {font-size:2.3rem;color:var(--cor-primaria);}
        .container {max-width:900px;margin:0 auto;padding:32px 12px;}
        .mes-selector {
            background: var(--cor-card);
            border-radius: 10px;
            padding: 12px 18px;
            margin-bottom: 24px;
            box-shadow: 0 1px 5px var(--cor-shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }
        .mes-selector button {
            background: var(--cor-fundo);
            border: none;
            width: 32px; height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: var(--cor-cinza);
            font-size: 1.1rem;
            transition: all .2s;
        }
        .mes-selector button:hover {
            background: var(--cor-primaria);
            color: #fff;
        }
        .mes-atual {
            flex: 1; text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            color: #222;
            letter-spacing: 1px;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
            gap: 14px;
            margin-bottom: 22px;
        }
        .card {
            background: var(--cor-card);
            border-radius: 10px;
            padding: 22px 18px;
            box-shadow: 0 2px 8px var(--cor-shadow);
            border: none;
            display: flex; flex-direction: column; align-items: flex-start;
        }
        .card-header {
            display: flex; align-items: center; gap: 7px; margin-bottom: 11px;
        }
        .card-header i {
            font-size: 1.1rem;
            padding: 6px; border-radius: 6px;
            background: var(--cor-fundo);
        }
        .card-header h3 {
            font-size: 1rem;
            font-weight: 600; color: var(--cor-cinza);
            letter-spacing: .5px;
            text-transform: uppercase;
        }
        .card-valor {
            font-size: 1.4rem;
            font-weight: 700;
        }
        .card.saldo .card-header i, .card.saldo .card-valor {color:var(--cor-primaria);}
        .card.receita .card-header i, .card.receita .card-valor {color:var(--cor-receita);}
        .card.despesa .card-header i, .card.despesa .card-valor {color:var(--cor-despesa);}
        /* Tabs lado a lado */
        .tabs-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 22px;
        }
        .tab-card {
            background: var(--cor-card);
            border-radius: 10px;
            box-shadow: 0 2px 8px var(--cor-shadow);
            border:none; 
            min-width:0;
            display: flex; flex-direction: column; align-items: stretch;
            padding: 10px 0;
        }
        .tab-header {
            padding: 11px 16px 7px 16px;
            border-bottom: 1px solid var(--cor-borda);
            display: flex; align-items: center; gap: 10px;
        }
        .tab-header.active {
            background: var(--cor-primaria);
            color: #fff;
            border-radius: 10px 10px 0 0;
        }
        .tab-header i {font-size:1.1em;}
        .tab-header h3 {font-size:1.07em;font-weight:600;}
        .tab-content {padding:0;}
        .lista-transacoes {max-height:350px;overflow-y:auto;}
        .categoria-bloco { margin-bottom: 20px; background: var(--cor-card); border-radius: 8px; box-shadow: 0 1px 6px var(--cor-shadow);}
        .categoria-titulo { padding: 10px 18px; font-size:1.07em; font-weight:700; color:var(--cor-primaria); border-bottom:1px solid #e9ecef; display:flex; align-items:center; gap:7px;}
        .categoria-titulo i {font-size:1.1em;}
        .transacoes-categoria {padding:6px 0;}
        .transacao {
            display:flex;align-items:center;gap:9px;
            padding:10px 10px;border-bottom:1px solid #f1f3f5;
            transition:background .2s;
        }
        .transacao:last-child {border-bottom:none;}
        .transacao:hover {background:var(--cor-fundo);}
        .transacao-icone {
            width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;
            font-size:.95em;flex-shrink:0;box-shadow:0 1px 4px var(--cor-shadow);
        }
        .transacao.receita .transacao-icone {background:#d1e7dd;color:var(--cor-receita);}
        .transacao.despesa .transacao-icone {background:#f8d7da;color:var(--cor-despesa);}
        .transacao-info {flex:1;min-width:0;}
        .transacao-desc {font-size:.97em;font-weight:500;color:#222;margin-bottom:2px;display:flex;align-items:center;}
        .transacao-edit-input {font-size:.97em;padding:2px 6px;width:70%;border:1px solid #dee2e6;border-radius:4px;}
        .transacao-edit-actions {display:inline-flex;gap:2px;}
        .transacao-meta {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 2px;
        }
        .transacao-meta-item {
            background: #f7f7fa;
            border-radius: 5px;
            padding: 2px 8px;
            font-size: 0.93em;
            color: #555;
            border: 1px solid #eee;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .transacao-meta-item i {
            font-size: 0.92em;
            margin-right: 2px;
        }
        .status-badge {
            display:inline-flex;align-items:center;padding:2px 7px;border-radius:4px;font-size:.92em;font-weight:500;
        }
        .status-badge.receita {background:#d1e7dd;color:#0a3622;}
        .status-badge.pendente {background:#fff3cd;color:#664d03;}
        .status-badge.paga {background:#f8d7da;color:#58151c;}
        .transacao-valor {font-size:.97em;font-weight:600;margin-right:4px;white-space:nowrap;}
        .transacao.receita .transacao-valor {color:var(--cor-receita);}
        .transacao.despesa .transacao-valor {color:var(--cor-despesa);}
        .transacao-acoes {display:flex;gap:2px;}
        .btn-acao {
            border:none;background:transparent;cursor:pointer;width:22px;height:22px;border-radius:3px;
            display:flex;align-items:center;justify-content:center;color:var(--cor-cinza);transition:all .2s;font-size:.88em;
        }
        .btn-acao i {font-size:.88em;}
        .btn-acao:hover {background:var(--cor-primaria);color:#fff;}
        .btn-acao.delete:hover {background:#f8d7da;color:var(--cor-despesa);}
        .lista-vazia {text-align:center;padding:18px 5px;}
        .lista-vazia i {font-size:2em;color:#dee2e6;margin-bottom:8px;}
        .lista-vazia p {font-size:.97em;color:var(--cor-cinza);}
        .modal {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);z-index:1000;align-items:center;justify-content:center;animation:fadeIn .2s;}
        .modal.ativo {display:flex;}
        @keyframes fadeIn {from{opacity:0;}to{opacity:1;}}
        .modal-conteudo {
            background:var(--cor-card);width:96%;max-width:400px;border-radius:10px;box-shadow:0 8px 32px var(--cor-shadow);
            animation:slideIn .25s ease;max-height:95vh;overflow-y:auto;
        }
        @keyframes slideIn {from{opacity:0;transform:translateY(-20px);}to{opacity:1;transform:translateY(0);}
        }
        .modal-header {display:flex;justify-content:space-between;align-items:center;padding:18px 16px;border-bottom:1px solid var(--cor-borda);}
        .modal-header h2 {font-size:1.15rem;font-weight:600;color:var(--cor-primaria);display:flex;align-items:center;gap:8px;}
        .modal-header h2 i {font-size:1.25rem;}
        .btn-fechar {background:transparent;border:none;width:28px;height:28px;border-radius:4px;cursor:pointer;color:var(--cor-cinza);transition:all .2s;display:flex;align-items:center;justify-content:center;font-size:1.25rem;}
        .btn-fechar:hover {background:var(--cor-fundo);color:#222;}
        .modal-body {padding:16px;}
        .tipo-selector {display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px;}
        .tipo-btn {padding:10px;border:2px solid #dee2e6;border-radius:6px;background:white;cursor:pointer;font-weight:600;font-size:1rem;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:7px;color:var(--cor-cinza);}
        .tipo-btn i {font-size:1rem;}
        .tipo-btn.receita.ativo {border-color:var(--cor-receita);background:#d1e7dd;color:var(--cor-receita);}
        .tipo-btn.despesa.ativo {border-color:var(--cor-despesa);background:#f8d7da;color:var(--cor-despesa);}
        .tipo-btn:hover:not(.ativo) {border-color:#adb5bd;}
        .form-group {margin-bottom:16px;}
        .form-group label {display:block;font-size:1rem;font-weight:600;color:#222;margin-bottom:6px;}
        .form-group input,.form-group select {width:100%;padding:8px 10px;border:1px solid #ced4da;border-radius:6px;font-size:1rem;font-family:inherit;transition:all .2s;background:white;color:#222;}
        .form-group input::placeholder {color:#adb5bd;}
        .form-group input:focus,.form-group select:focus {outline:none;border-color:var(--cor-primaria);box-shadow:0 0 0 2px rgba(13,110,253,0.1);}
        .btn-submit {width:100%;padding:10px;background:var(--cor-primaria);color:white;border:none;border-radius:6px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:8px;}
        .btn-submit:hover {background:#0b5ed7;}
        .btn-submit:active {transform:scale(0.98);}
        .btn-submit i {font-size:1rem;}
        .fab {position:fixed;bottom:22px;right:22px;width:50px;height:50px;border-radius:50%;background:var(--cor-primaria);border:none;cursor:pointer;box-shadow:0 4px 14px var(--cor-shadow);font-size:1.35rem;color:white;transition:all .2s;display:flex;align-items:center;justify-content:center;z-index:500;}
        .fab:hover {background:#0b5ed7;transform:scale(1.08);}
        .fab:active {transform:scale(0.97);}
        .loading {text-align:center;padding:40px 20px;color:var(--cor-cinza);}
        .loading i {font-size:2rem;margin-bottom:12px;}
        .modal-date { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.4); align-items: center; justify-content: center; }
        .modal-date.ativo { display: flex; }
        .modal-date-content { background: #fff; padding: 20px 10px; border-radius: 10px; max-width: 340px; margin: 10px; box-shadow: 0 8px 32px var(--cor-shadow); text-align:center; }
        .modal-date-content label { font-weight: 600; margin-bottom: 8px; display: block; color: #222;}
        .modal-date-content input[type="date"] { font-size: 1rem; padding: 6px 8px; width: 90%; margin-bottom: 12px; }
        .modal-date-content .btn { margin: 0 4px; }
        @media (max-width: 700px) {
            .container {padding:12px 2px;}
            .dashboard {grid-template-columns:1fr;gap:10px;}
            .card {padding:10px;}
            .card-valor {font-size:1.1rem;}
            .modal-conteudo {width:99%;margin:1px;}
            .modal-date-content {padding:8px;max-width:99vw;}
            .fab {bottom:8px;right:8px;width:40px;height:40px;font-size:1.1rem;}
            .transacao {gap:5px;padding:7px 2px;font-size:.92rem;}
            .transacao-desc, .transacao-edit-input {font-size:.93rem;width:98%;}
            .form-group input, .form-group select {font-size:.96rem;padding:6px 7px;}
            .tabs-row {grid-template-columns:1fr;}
            .tab-card {margin-bottom:10px;}
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="topbar-content">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <span>Financeiro Moderno</span>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="mes-selector">
            <button id="btnMesAnterior" title="Mês Anterior"><i class="fas fa-chevron-left"></i></button>
            <div class="mes-atual" id="mesAtual">Carregando...</div>
            <button id="btnMesProximo" title="Próximo Mês"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="dashboard">
            <div class="card saldo">
                <div class="card-header"><i class="fas fa-wallet"></i><h3>Saldo Atual</h3></div>
                <div class="card-valor" id="saldoAtual">R$ 0,00</div>
            </div>
            <div class="card receita">
                <div class="card-header"><i class="fas fa-arrow-trend-up"></i><h3>Receitas</h3></div>
                <div class="card-valor" id="totalReceitas">R$ 0,00</div>
            </div>
            <div class="card despesa">
                <div class="card-header"><i class="fas fa-arrow-trend-down"></i><h3>Despesas Pendentes</h3></div>
                <div class="card-valor" id="despesasPendentes">R$ 0,00</div>
            </div>
        </div>
        <div class="tabs-row">
            <div class="tab-card" id="tabCardPendentes">
                <div class="tab-header active"><i class="fas fa-hourglass-half"></i><h3>Pendentes</h3></div>
                <div class="tab-content" id="blocosPendentes"></div>
            </div>
            <div class="tab-card" id="tabCardPagas">
                <div class="tab-header"><i class="fas fa-check-circle"></i><h3>Pagas</h3></div>
                <div class="tab-content" id="blocosPagas"></div>
            </div>
        </div>
    </div>
    <button class="fab" id="btnAdicionar" title="Adicionar Transação"><i class="fas fa-plus"></i></button>
    <div class="modal" id="modal">
        <div class="modal-conteudo">
            <div class="modal-header">
                <h2><i class="fas fa-plus-circle"></i>Nova Transação</h2>
                <button class="btn-fechar" id="btnFechar">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tipo-selector">
                    <button class="tipo-btn receita ativo" data-tipo="receita"><i class="fas fa-plus"></i>Receita</button>
                    <button class="tipo-btn despesa" data-tipo="despesa"><i class="fas fa-minus"></i>Despesa</button>
                </div>
                <form id="formulario">
                    <div class="form-group">
                        <label for="descricao">Descrição</label>
                        <input type="text" id="descricao" placeholder="Ex: Salário, Aluguel..." required>
                    </div>
                    <div class="form-group">
                        <label for="valor">Valor (R$)</label>
                        <input type="number" id="valor" placeholder="0,00" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="grupo">Categoria</label>
                        <select id="grupo" required>
                            <option value="">Selecione uma categoria</option>
                            <optgroup label="Receitas">
                                <option value="Salário">Salário</option>
                                <option value="Freelance">Freelance</option>
                                <option value="Investimento">Investimento</option>
                                <option value="Outro">Outro</option>
                            </optgroup>
                            <optgroup label="Despesas">
                                <option value="Aluguel">Aluguel</option>
                                <option value="Alimentação">Alimentação</option>
                                <option value="Transporte">Transporte</option>
                                <option value="Carro">Carro</option>
                                <option value="Compras">Compras</option>
                                <option value="Lazer">Lazer</option>
                                <option value="Saúde">Saúde</option>
                                <option value="Outro">Outro</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data</label>
                        <button type="button" id="btnSelecionarData" class="btn-submit" style="background:#f8f9fa; color:#222; border:1px solid #ced4da;">
                            <i class="fas fa-calendar"></i>
                            <span id="dataSelecionadaLabel">Selecionar Data</span>
                        </button>
                    </div>
                    <div class="form-group" id="parcelasGroup" style="display:none;">
                        <label for="parcelas">Parcelas</label>
                        <input type="number" id="parcelas" min="1" max="36" value="1" required>
                    </div>
                    <button type="submit" class="btn-submit"><i class="fas fa-check"></i>Adicionar Transação</button>
                </form>
            </div>
        </div>
    </div>
    <div class="modal-date" id="modalDate">
        <div class="modal-date-content">
            <label for="dataModalInput">Selecione a Data</label>
            <input type="date" id="dataModalInput">
            <div>
                <button class="btn btn-submit" id="btnConfirmarData" type="button">Confirmar</button>
                <button class="btn btn-fechar" id="btnFecharData" type="button">Cancelar</button>
            </div>
        </div>
    </div>
    <script>
        let tipoAtual = 'receita';
        let mesAtualIndex = new Date().getMonth();
        let anoAtual = new Date().getFullYear();
        let transacoes = [];
        let dataSelecionada = '';
        let editandoId = null;

        const els = {
            formulario: document.getElementById('formulario'),
            descricao: document.getElementById('descricao'),
            valor: document.getElementById('valor'),
            grupo: document.getElementById('grupo'),
            btnSelecionarData: document.getElementById('btnSelecionarData'),
            dataSelecionadaLabel: document.getElementById('dataSelecionadaLabel'),
            parcelasGroup: document.getElementById('parcelasGroup'),
            parcelas: document.getElementById('parcelas'),
            blocosPendentes: document.getElementById('blocosPendentes'),
            blocosPagas: document.getElementById('blocosPagas'),
            saldoAtual: document.getElementById('saldoAtual'),
            totalReceitas: document.getElementById('totalReceitas'),
            despesasPendentes: document.getElementById('despesasPendentes'),
            tipoButtons: document.querySelectorAll('.tipo-btn'),
            modal: document.getElementById('modal'),
            btnAdicionar: document.getElementById('btnAdicionar'),
            btnFechar: document.getElementById('btnFechar'),
            mesAtual: document.getElementById('mesAtual'),
            btnMesAnterior: document.getElementById('btnMesAnterior'),
            btnMesProximo: document.getElementById('btnMesProximo'),
            modalDate: document.getElementById('modalDate'),
            dataModalInput: document.getElementById('dataModalInput'),
            btnConfirmarData: document.getElementById('btnConfirmarData'),
            btnFecharData: document.getElementById('btnFecharData')
        };

        const meses = [
            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];

        const icones = {
            Salário: 'fa-money-bill-wave',
            Freelance: 'fa-briefcase',
            Investimento: 'fa-piggy-bank',
            Outro: 'fa-plus',
            Aluguel: 'fa-home',
            Alimentação: 'fa-utensils',
            Transporte: 'fa-bus',
            Carro: 'fa-car',
            Compras: 'fa-shopping-cart',
            Lazer: 'fa-gamepad',
            Saúde: 'fa-heartbeat'
        };

        function obterChaveMes() {
            return `transacoes:${anoAtual}-${String(mesAtualIndex + 1).padStart(2, '0')}`;
        }

        function atualizarTituloMes() {
            els.mesAtual.textContent = `${meses[mesAtualIndex]} ${anoAtual}`;
        }

        function atualizarOpcoes() {
            const optgroups = els.grupo.querySelectorAll('optgroup');
            optgroups.forEach(og => og.style.display = 'none');
            if (tipoAtual === 'receita') {
                optgroups[0].style.display = 'block';
                els.parcelasGroup.style.display = 'none';
            } else {
                optgroups[1].style.display = 'block';
                els.parcelasGroup.style.display = 'block';
            }
        }

        function carregarTransacoes() {
            const chave = obterChaveMes();
            const valor = localStorage.getItem(chave);
            if (valor) {
                transacoes = JSON.parse(valor);
            } else {
                transacoes = [];
            }
            renderizar();
        }

        function salvarTransacoes() {
            try {
                const chave = obterChaveMes();
                localStorage.setItem(chave, JSON.stringify(transacoes));
            } catch (error) {
                console.error('Erro ao salvar transações:', error);
                alert('Erro ao salvar. Tente novamente.');
            }
        }

        function renderizar() {
            const saldos = calcularSaldos();
            els.saldoAtual.textContent = formatarValor(saldos.saldo);
            els.totalReceitas.textContent = formatarValor(saldos.totalReceitas);
            els.despesasPendentes.textContent = formatarValor(saldos.totalDespesasPendentes);

            function agruparPorCategoria(transacoes) {
                const categorias = {};
                transacoes.forEach(t => {
                    if (!categorias[t.grupo]) categorias[t.grupo] = [];
                    categorias[t.grupo].push(t);
                });
                return categorias;
            }

            // Pendentes
            let pendentes = transacoes.filter(t => t.tipo === 'receita' || (t.tipo === 'despesa' && t.status === 'pendente'));
            const categoriasPendentes = agruparPorCategoria(pendentes);
            let htmlPendentes = '';
            if (pendentes.length === 0) {
                htmlPendentes = '<div class="lista-vazia"><i class="fas fa-inbox"></i><p>Nenhuma transação pendente</p></div>';
            } else {
                Object.entries(categoriasPendentes).forEach(([categoria, lista]) => {
                    htmlPendentes += `
                    <div class="categoria-bloco">
                        <div class="categoria-titulo"><i class="fas fa-tag"></i> ${categoria}</div>
                        <div class="transacoes-categoria">
                        ${lista.map(t => `
                            <div class="transacao ${t.tipo}">
                                <div class="transacao-icone">
                                    <i class="fas ${icones[t.grupo] || 'fa-circle'}"></i>
                                </div>
                                <div class="transacao-info">
                                    <div class="transacao-desc" id="desc-${t.id}">
                                        ${editandoId === t.id
                                            ? `<input class="transacao-edit-input" id="editInput-${t.id}" value="${t.descricao.replace(/"/g, '&quot;')}" />
                                               <span class="transacao-edit-actions">
                                                 <button class="btn-acao" onclick="salvarEdicao(${t.id})" title="Salvar"><i class="fas fa-check"></i></button>
                                                 <button class="btn-acao" onclick="cancelarEdicao()" title="Cancelar"><i class="fas fa-times"></i></button>
                                               </span>`
                                            : `${t.descricao}
                                               <button class="btn-acao" onclick="editarTransacao(${t.id})" title="Editar nome">
                                                 <i class="fas fa-pencil"></i>
                                               </button>`
                                        }
                                    </div>
                                    <div class="transacao-meta">
                                        <span class="transacao-meta-item">
                                            <i class="fas fa-calendar"></i> ${t.data}
                                        </span>
                                        ${t.parcelaAtual && t.totalParcelas ? `
                                        <span class="transacao-meta-item">
                                            <i class="fas fa-file-invoice"></i> Parcela ${t.parcelaAtual}/${t.totalParcelas}
                                        </span>
                                        ` : ""}
                                    </div>
                                </div>
                                <div class="transacao-valor">${t.tipo === 'receita' ? '+' : '-'} ${formatarValor(t.valor)}</div>
                                <span class="status-badge ${t.tipo === 'receita' ? 'receita' : (t.status === 'paga' ? 'paga' : 'pendente')}">
                                    ${t.tipo === 'receita' ? 'Recebida' : (t.status === 'paga' ? 'Paga' : 'Pendente')}
                                </span>
                                <div class="transacao-acoes">
                                    ${
                                        (t.tipo === 'despesa')
                                        ? `<button class="btn-acao" onclick="alternarStatusDespesa(${t.id})" title="Marcar como paga"><i class="fas fa-check"></i></button>`
                                        : ''
                                    }
                                    <button class="btn-acao delete" onclick="deletarTransacao(${t.id})" title="Deletar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                        </div>
                    </div>
                    `;
                });
            }
            els.blocosPendentes.innerHTML = htmlPendentes;

            // Pagas
            let pagas = transacoes.filter(t => t.tipo === 'despesa' && t.status === 'paga');
            const categoriasPagas = agruparPorCategoria(pagas);
            let htmlPagas = '';
            if (pagas.length === 0) {
                htmlPagas = '<div class="lista-vazia"><i class="fas fa-inbox"></i><p>Nenhuma transação paga</p></div>';
            } else {
                Object.entries(categoriasPagas).forEach(([categoria, lista]) => {
                    htmlPagas += `
                    <div class="categoria-bloco">
                        <div class="categoria-titulo"><i class="fas fa-tag"></i> ${categoria}</div>
                        <div class="transacoes-categoria">
                        ${lista.map(t => `
                            <div class="transacao despesa">
                                <div class="transacao-icone">
                                    <i class="fas ${icones[t.grupo] || 'fa-circle'}"></i>
                                </div>
                                <div class="transacao-info">
                                    <div class="transacao-desc" id="desc-${t.id}">
                                        ${editandoId === t.id
                                            ? `<input class="transacao-edit-input" id="editInput-${t.id}" value="${t.descricao.replace(/"/g, '&quot;')}" />
                                               <span class="transacao-edit-actions">
                                                 <button class="btn-acao" onclick="salvarEdicao(${t.id})" title="Salvar"><i class="fas fa-check"></i></button>
                                                 <button class="btn-acao" onclick="cancelarEdicao()" title="Cancelar"><i class="fas fa-times"></i></button>
                                               </span>`
                                            : `${t.descricao}
                                               <button class="btn-acao" onclick="editarTransacao(${t.id})" title="Editar nome">
                                                 <i class="fas fa-pencil"></i>
                                               </button>`
                                        }
                                    </div>
                                    <div class="transacao-meta">
                                        <span class="transacao-meta-item">
                                            <i class="fas fa-calendar"></i> ${t.data}
                                        </span>
                                        ${t.parcelaAtual && t.totalParcelas ? `
                                        <span class="transacao-meta-item">
                                            <i class="fas fa-file-invoice"></i> Parcela ${t.parcelaAtual}/${t.totalParcelas}
                                        </span>
                                        ` : ""}
                                    </div>
                                </div>
                                <div class="transacao-valor">- ${formatarValor(t.valor)}</div>
                                <span class="status-badge paga">Paga</span>
                                <div class="transacao-acoes">
                                    <button class="btn-acao" onclick="alternarStatusDespesa(${t.id})" title="Voltar para pendente">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    <button class="btn-acao delete" onclick="deletarTransacao(${t.id})" title="Deletar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                        </div>
                    </div>
                    `;
                });
            }
            els.blocosPagas.innerHTML = htmlPagas;

            // Foco no input ao editar
            if (editandoId !== null) {
                setTimeout(() => {
                    const input = document.getElementById(`editInput-${editandoId}`);
                    if (input) { input.focus(); input.select(); }
                }, 50);
            }
        }

        function calcularSaldos() {
            const totalReceitas = transacoes.filter(t => t.tipo === 'receita').reduce((acc, t) => acc + t.valor, 0);
            const totalDespesasPagas = transacoes.filter(t => t.tipo === 'despesa' && t.status === 'paga').reduce((acc, t) => acc + t.valor, 0);
            const totalDespesasPendentes = transacoes.filter(t => t.tipo === 'despesa' && t.status === 'pendente').reduce((acc, t) => acc + t.valor, 0);
            const saldo = totalReceitas - totalDespesasPagas;
            return { saldo, totalReceitas, totalDespesasPendentes, totalDespesasPagas };
        }

        function formatarValor(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        function alternarStatusDespesa(id) {
            const transacao = transacoes.find(t => t.id === id);
            if (transacao && transacao.tipo === 'despesa') {
                transacao.status = transacao.status === 'pendente' ? 'paga' : 'pendente';
                salvarTransacoes();
                renderizar();
            }
        }

        function deletarTransacao(id) {
            if (confirm('Deseja deletar esta transação?')) {
                transacoes = transacoes.filter(t => t.id !== id);
                salvarTransacoes();
                renderizar();
            }
        }

        window.alternarStatusDespesa = alternarStatusDespesa;
        window.deletarTransacao = deletarTransacao;

        function editarTransacao(id) {
            editandoId = id;
            renderizar();
        }
        window.editarTransacao = editarTransacao;

        function salvarEdicao(id) {
            const input = document.getElementById(`editInput-${id}`);
            if (input) {
                const novoNome = input.value.trim();
                if (novoNome) {
                    const transacao = transacoes.find(t => t.id === id);
                    if (transacao) {
                        transacao.descricao = novoNome;
                        salvarTransacoes();
                    }
                }
            }
            editandoId = null;
            renderizar();
        }
        window.salvarEdicao = salvarEdicao;

        function cancelarEdicao() {
            editandoId = null;
            renderizar();
        }
        window.cancelarEdicao = cancelarEdicao;

        els.btnMesAnterior.addEventListener('click', () => {
            mesAtualIndex--;
            if (mesAtualIndex < 0) {
                mesAtualIndex = 11;
                anoAtual--;
            }
            editandoId = null;
            atualizarTituloMes();
            carregarTransacoes();
        });

        els.btnMesProximo.addEventListener('click', () => {
            mesAtualIndex++;
            if (mesAtualIndex > 11) {
                mesAtualIndex = 0;
                anoAtual++;
            }
            editandoId = null;
            atualizarTituloMes();
            carregarTransacoes();
        });

        els.btnAdicionar.addEventListener('click', () => {
            els.modal.classList.add('ativo');
            dataSelecionada = '';
            els.dataSelecionadaLabel.textContent = 'Selecionar Data';
        });

        els.btnFechar.addEventListener('click', () => {
            els.modal.classList.remove('ativo');
        });

        els.modal.addEventListener('click', (e) => {
            if (e.target === els.modal) {
                els.modal.classList.remove('ativo');
            }
        });

        els.tipoButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                els.tipoButtons.forEach(b => b.classList.remove('ativo'));
                btn.classList.add('ativo');
                tipoAtual = btn.dataset.tipo;
                els.grupo.value = '';
                atualizarOpcoes();
            });
        });

        els.btnSelecionarData.addEventListener('click', () => {
            els.modalDate.classList.add('ativo');
            els.dataModalInput.value = '';
        });
        els.btnFecharData.addEventListener('click', () => {
            els.modalDate.classList.remove('ativo');
        });
        els.btnConfirmarData.addEventListener('click', () => {
            if (!els.dataModalInput.value) {
                alert("Selecione uma data!");
                return;
            }
            dataSelecionada = els.dataModalInput.value;
            els.dataSelecionadaLabel.textContent = new Date(dataSelecionada + 'T00:00:00').toLocaleDateString('pt-BR');
            els.modalDate.classList.remove('ativo');
        });

        els.formulario.addEventListener('submit', function(e) {
            e.preventDefault();
            if (!els.descricao.value || !els.valor.value || !els.grupo.value || !dataSelecionada) {
                alert('Preencha todos os campos!');
                return;
            }
            if (tipoAtual === 'despesa') {
                let parcelas = parseInt(els.parcelas.value) || 1;
                for(let i=0; i<parcelas; i++) {
                    let dt = new Date(dataSelecionada);
                    dt.setMonth(dt.getMonth() + i);
                    transacoes.push({
                        id: Date.now() + i,
                        descricao: els.descricao.value + (parcelas > 1 ? ` (${i+1}/${parcelas})` : ""),
                        valor: parseFloat(els.valor.value),
                        grupo: els.grupo.value,
                        tipo: tipoAtual,
                        status: 'pendente',
                        data: dt.toLocaleDateString('pt-BR'),
                        dataOriginal: dt.toISOString().slice(0,10),
                        parcelaAtual: i+1,
                        totalParcelas: parcelas
                    });
                }
            } else {
                transacoes.push({
                    id: Date.now(),
                    descricao: els.descricao.value,
                    valor: parseFloat(els.valor.value),
                    grupo: els.grupo.value,
                    tipo: tipoAtual,
                    status: 'recebida',
                    data: new Date(dataSelecionada + 'T00:00:00').toLocaleDateString('pt-BR'),
                    dataOriginal: dataSelecionada
                });
            }
            salvarTransacoes();
            renderizar();
            els.formulario.reset();
            els.modal.classList.remove('ativo');
            dataSelecionada = '';
            els.dataSelecionadaLabel.textContent = 'Selecionar Data';
        });

        atualizarOpcoes();
        atualizarTituloMes();
        carregarTransacoes();
    </script>
</body>
</html>
